# Plan: устранение замечаний по проекту Timer Widget

Дата: 2026-01-20
Автор: Codex (GPT-5)

## Цель
Закрыть выявленные риски и несоответствия по безопасности, стабильности, документации и качеству.

## Объем
План охватывает:
- безопасность Electron окон
- корректность IPC-разрешений
- базовую CSP защиту
- синхронизацию документации с кодом
- минимальный набор тестов
- проверку соответствия утилит и реального использования

## Фаза 1. Безопасность (критично)

1. Привести fullscreen окно к безопасной конфигурации
   - Шаг 1: В electron-main.js заменить для display окна:
     - nodeIntegration: false
     - contextIsolation: true
     - preload: path.join(__dirname, 'preload.js')
     - sandbox: true (если не требуется доступ к Node.js)
   - Шаг 2: В display.html подключить ipc-compat.js перед display-script.js.
   - Шаг 3: В display-script.js убрать require('electron') и использовать window.ipcRenderer.
   - Шаг 4: Протестировать: fullscreen открывается, таймер синхронизируется, клавиши работают.
   - Оценка времени: 1.5–2.5 часа.
   - Файлы: electron-main.js, display.html, display-script.js.

2. Включить sandbox там, где не нужен прямой доступ
   - Шаг 1: Проверить, используют ли окна прямой доступ к Node.js.
   - Шаг 2: Если не используют, заменить sandbox: false на true.
   - Шаг 3: Проверить localStorage/IPC после изменения.
   - Оценка времени: 0.5–1 час.
   - Файлы: electron-main.js.
   - Статус: сделано (2026-01-20).

3. Добавить CSP в HTML окна
   - Шаг 1: Добавить meta CSP в <head> каждого HTML.
   - Шаг 2: Начать с умеренной политики (self + data) без ломания UI.
   - Шаг 3: Проверить, что все стили и скрипты работают.
   - Оценка времени: 1–1.5 часа.
   - Файлы: electron-control.html, electron-widget.html, electron-clock-widget.html, display.html.
   - Статус: сделано (2026-01-20).

## Фаза 2. IPC и стабильность

4. Исправить allowlist IPC каналов
   - Шаг 1: Собрать список всех ipcRenderer.send/on в проекте.
   - Шаг 2: Обновить ALLOWED_CHANNELS.send и receive в preload.js.
   - Шаг 3: Проверить, что ipc-compat.js корректно проксирует.
   - Оценка времени: 1–2 часа.
   - Файлы: preload.js, ipc-compat.js.

5. Проверить конфликт между allowlist и кодом
   - Шаг 1: Сверить каналы из каждого окна с allowlist.
   - Шаг 2: Исправить несоответствия (добавить каналы или заменить вызовы).
   - Шаг 3: Проверить логи на “Blocked attempt”.
   - Оценка времени: 1–1.5 часа.
   - Файлы: electron-control.html, electron-widget.html, electron-clock-widget.html, display-script.js, preload.js.

## Фаза 3. Документация и версия

6. Синхронизировать версии
   - Шаг 1: Сравнить фактические версии в package.json.
   - Шаг 2: Обновить README и ARCHITECTURE до актуальных данных.
   - Шаг 3: Проверить, что версионные номера совпадают.
   - Оценка времени: 0.5–1 час.
   - Файлы: README.md, docs/planning/ARCHITECTURE.md.
   - Статус: сделано (2026-01-20).

7. Привести статус багов в актуальное состояние
   - Шаг 1: Сверить список багов с текущим кодом.
   - Шаг 2: Обновить STATUS.md и FIXES_APPLIED.md.
   - Шаг 3: Отразить нерешенные задачи отдельно.
   - Оценка времени: 1–2 часа.
   - Файлы: docs/bugs/STATUS.md, docs/bugs/FIXES_APPLIED.md.
   - Статус: сделано (2026-01-20).

## Фаза 4. Минимальные тесты

8. Добавить базовые тесты для критичных функций
   - Шаг 1: Добавить тестовый скрипт в package.json (node --test).
   - Шаг 2: Добавить тесты на форматирование времени.
   - Шаг 3: Добавить тесты на расчет прогресса.
   - Шаг 4: Добавить тесты на валидацию пользовательского ввода.
   - Оценка времени: 2–4 часа.
   - Файлы: package.json, tests/*.
   - Статус: сделано (2026-01-20).

## Фаза 5. Верификация

9. Проверка ручных сценариев
   - Шаг 1: Проверить старт/пауза/ресет в control окне.
   - Шаг 2: Проверить синхронизацию с widget и display.
   - Шаг 3: Проверить звуки и фоновое изображение.
   - Оценка времени: 1–2 часа.
   - Статус: пропущено по запросу (не проверено) — 2026-01-20.

10. Финальная проверка безопасности
   - Шаг 1: Убедиться, что require недоступен в renderer.
   - Шаг 2: Проверить CSP (нет ошибок в консоли).
   - Шаг 3: Проверить, что лишние IPC каналы блокируются.
   - Оценка времени: 0.5–1 час.
   - Статус: пропущено по запросу (не проверено) — 2026-01-20.

## Верификация (автоматическая)

- ✅ Тесты utils выполнены: `npm test` (7 тестов, 0 ошибок) — 2026-01-20.

## Примечания
- Приоритет: Фаза 1 и 2 обязательны до релиза.
- Фаза 3 и 4 желательны, чтобы проект было легче поддерживать.
- Фаза 5 обязательна перед выпуском.
